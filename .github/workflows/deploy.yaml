name: Deploy to SiteGround

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2
          extensions: mbstring, intl, pdo_mysql, zip, bcmath

      - name: Composer Install
        run: composer install --no-dev --optimize-autoloader

      - name: Build Vite
        run: |
          npm ci
          npm run build

      # Upload all Laravel files to the server
      - name: Upload via FTP
        uses: SamKirkland/FTP-Deploy-Action@4.3.0
        with:
          server: ${{ secrets.SG_FTP_HOST }}
          username: ${{ secrets.SG_FTP_USER }}
          password: ${{ secrets.SG_FTP_PASS }}
          server-dir: public_html/
          timeout: 120000

      # Run Laravel commands via SSH on SiteGround
      - name: Run artisan commands
        uses: appleboy/ssh-action@master
        with:
          host: manolisl.sg-host.com
          username: ${{ secrets.SG_SSH_USER }}
          password: ${{ secrets.SG_SSH_PASS }}
          port: 18765
          script: |
            cd /home/customer/www/manolisl.sg-host.com/public_html

            echo "➡ Running migrations"
            /usr/local/bin/php artisan migrate --force

            echo "➡ Optimizing"
            /usr/local/bin/php artisan optimize:clear || true
            /usr/local/bin/php artisan config:cache
            /usr/local/bin/php artisan route:cache
            /usr/local/bin/php artisan view:cache

            echo "➡ Fixing permissions"
            chmod -R 775 storage bootstrap/cache
            find storage -type f -exec chmod 664 {} \;
            find bootstrap/cache -type f -exec chmod 664 {} \;

            echo "➡ Deployment completed!"
